apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-check-agent
  namespace: kube-check-system
  labels:
    app: kube-check-agent
spec:
  selector:
    matchLabels:
      app: kube-check-agent
  template:
    metadata:
      labels:
        app: kube-check-agent
    spec:
      serviceAccountName: kube-check-agent
      hostPID: true  # Required to run 'ps' on host processes
      hostNetwork: true # Optional: depending on if you want to reach host network directly
      containers:
      - name: agent
        image: kube-check-backend:latest # Placeholder image name
        securityContext:
          privileged: true # Gives root access to host
        volumeMounts:
        - name: etc-kubernetes
          mountPath: /etc/kubernetes
          readOnly: false # Allow write for remediation
        - name: var-lib-etcd
          mountPath: /var/lib/etcd
          readOnly: false
        - name: var-lib-kubelet
          mountPath: /var/lib/kubelet
          readOnly: false
        - name: usr-bin
          mountPath: /usr/bin
          readOnly: true
        - name: etc-systemd
          mountPath: /etc/systemd
          readOnly: false
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
      volumes:
      - name: etc-kubernetes
        hostPath:
          path: /etc/kubernetes
      - name: var-lib-etcd
        hostPath:
          path: /var/lib/etcd
      - name: var-lib-kubelet
        hostPath:
          path: /var/lib/kubelet
      - name: usr-bin
        hostPath:
          path: /usr/bin
      - name: etc-systemd
        hostPath:
          path: /etc/systemd
